<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Calming Meditation</title>

    <link rel="stylesheet" href="pico.css">
    <style>
    </style>
    <script type="text/javascript">
        let settings = JSON.parse(localStorage.getItem('meditator'));
        let { meditationDelay, delay, volume, bellSound } = { ...{ meditationDelay: 600_000, delay: 120000, volume: 0.5, bellSound: 'bell1.wav' }, ...settings, }
        let interval = null;
        let request = window.indexedDB.open("Keep Window Open", 3);
        let meditationTimer = null;
        let backgroundPlaying = false;
        let audio;
        const playSound = () => {
            try {
                audio.pause();
            } catch (e) {

            }
            audio = new Audio(bellSound);
            audio.volume = volume;
            audio.play();
            console.log('Play ' + interval);
        };

        async function playBackground() {
            if (backgroundPlaying) return;
            try {
                var audio = new Audio('silence.wav');
                audio.volume = 1;
                audio.loop = true
                audio.play();
            } catch (e) {
                backgroundPlaying = false;
            }
        }

        const wait = (ms) => new Promise(r => setTimeout(r, ms));

        const startBell = () => {
            if (interval == null) {
                playSound();
                console.log('Interval set to ' + delay);
                interval = setInterval(() => {
                    playSound();
                }, delay);
            } else {
                alert('Sound already running');
            }
        };

        function stopBell() {
            clearInterval(interval);
            interval = null;
            console.log('Stopped');
        };

        function resetBell(timerInterval, displayValue) {
            delay = timerInterval;
            console.log('Timer set to ' + displayValue + ' ' + timerInterval);
            if (interval !== null) {
                stopBell();
                startBell();
                console.log("Restarted Bell");
            }
        }

        function resetMeditation(timerInterval, displayValue) {
            meditationDelay = timerInterval;
            console.log('Meditation timer set to ' + displayValue);
            if (meditationTimer !== null) {
                stopMeditation();
                startMeditation();
                console.log("Restarted Meditation");
            }
        }

        function startMeditation() {
            if (meditationTimer == null) {
                meditationTimer = setTimeout(async () => {
                    playSound();
                    await wait(2000);
                    playSound();
                    await wait(2000);
                    playSound();
                    stop();
                }, meditationDelay);
            } else {
                alert('Meditation already running');
            }
        };

        function stopMeditation() {
            clearTimeout(meditationTimer);
            meditationTimer = null;
            console.log('Stopped Meditation');
        };

        function start() {
            startBell();
            startMeditation();
        }

        function stop() {
            stopBell();
            stopMeditation();
        }

        function setVolume(vol) {
            console.log(vol);
            volume = vol;
        }

        function saveSettings() {
            localStorage.setItem('meditator', JSON.stringify({ volume, meditationDelay, delay, bellSound }))
        }

        function resetBellSound(sound, description) {
            console.log('new sound' + sound);
            bellSound = sound;
            playSound();
        }
    </script>
</head>

<body onclick="playBackground()">
    <main class="container">
        <h4>Bell</h4>
        <select id="bellSoundSelector" style="margin-top: -20px;"
            onchange="resetBellSound(event.currentTarget.value, event.currentTarget.options[event.currentTarget.selectedIndex].text);saveSettings()"
            id="timerInterval">
            <option value="bell1.wav">Bell</option>
            <option value="bell2.wav">Ding?</option>
            <option value="bell3.mp3">Clear as Bell</option>
            <option value="bong.wav">Bong</option>
            <option value="deep bowl.wav">Deep Bowl</option>
            <option value="longbell.wav">Long Gong</option>
            <option value="ting.wav">Ting</option>
        </select>

        <h4>Bell Interval</h4>

        <select id="delaySelector" style="margin-top: -20px;"
            onchange="resetBell(event.currentTarget.value, event.currentTarget.options[event.currentTarget.selectedIndex].text);saveSettings()"
            id="timerInterval">
            <option value="15000">fifteen seconds</option>
            <option value="30000">thirty seconds</option>
            <option value="60000">one minute</option>
            <option selected="true" value="120000">two minutes</option>
            <option value="180000">three minutes</option>
            <option value="300000">five minutes</option>
            <option value="600000">ten minutes</option>
            <option value="1200000">twenty minutes</option>
            <option value="1800000">thirty minutes</option>
        </select>


        <h4>Meditation Session Time</h4>
        <select id="meditationDelaySelector" style="margin-top: -20px;"
            onchange="resetMeditation(event.currentTarget.value, event.currentTarget.options[event.currentTarget.selectedIndex].text);saveSettings()"
            id="timerInterval">
            <option value="60000">one minute</option>
            <option value="300000">five minutes</option>
            <option selected value="600000">ten minutes</option>
            <option value="1200000">twenty minutes</option>
            <option value="1800000">thirty minutes</option>
            <option value="1800000">forty five minutes</option>
            <option value="2700000">forty-five minutes</option>
            <option value="3300000">fifty-five minutes</option>
            <option value="3600000">sixty minutes</option>
        </select>
        <h4>Volume</h4>
        <input id="volumeSlider" style="margin-top: -20px;"
            onchange="setVolume(event.currentTarget.value);saveSettings()" type="range" min="0" max="1" step="0.1" />
        <p></p>
        <button onclick="start()">Start</button>
        <button onclick="stop()">Stop</button>

    </main>

</body>
<script>
    document.getElementById('bellSoundSelector').value = bellSound;
    document.getElementById('volumeSlider').value = volume;
    document.getElementById('delaySelector').value = delay;
    document.getElementById('meditationDelaySelector').value = meditationDelay;

</script>

</html>